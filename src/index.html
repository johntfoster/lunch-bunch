<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Lunch Bunch</title>
<meta name="theme-color" content="#1a1a1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Lunch Bunch">
<script>
  // Detect Capacitor native app and add class for full-screen styling
  if (window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform()) {
    document.documentElement.classList.add('capacitor-native');
  }
</script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;600&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html { height: 100%; overflow: hidden; overscroll-behavior: none; touch-action: none; }
  body { height: 100%; overflow: hidden; position: fixed; width: 100%; overscroll-behavior: none; touch-action: manipulation; }

  :root {
    --primary: #bf5700;
    --primary-dark: #994600;
    --dark-steel: #2c2c2c;
    --medium-gray: #4a4a4a;
    --near-black: #1a1a1a;
    --text: #f5e6d0;
    --text-muted: #a0a0a0;
    --accent-gold: #c4841d;
    --success: #4adb7b;
    --danger: #e74c3c;
  }

  body {
    background: linear-gradient(180deg, #1a1a1a 0%, #2c2c2c 100%);
    font-family: 'Source Sans 3', sans-serif;
    color: var(--text);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
    -webkit-font-smoothing: antialiased;
  }

  .phone-frame {
    width: 375px;
    height: 812px;
    background: var(--near-black);
    border-radius: 40px;
    border: 3px solid var(--medium-gray);
    overflow: hidden;
    position: relative;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.05);
  }

  @media (max-width: 430px), (display-mode: standalone) {
    body { padding: 0; background: var(--near-black); }
    .phone-frame {
      width: 100%; height: 100vh; height: 100dvh;
      border-radius: 0; border: none; box-shadow: none;
      padding-top: env(safe-area-inset-top, 0px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
      padding-left: env(safe-area-inset-left, 0px);
      padding-right: env(safe-area-inset-right, 0px);
    }
  }

  /* Capacitor native app ‚Äî always full screen, no frame */
  @media (max-width: 9999px) {
    .capacitor-native .phone-frame {
      width: 100%; height: 100vh; height: 100dvh;
      border-radius: 0; border: none; box-shadow: none;
      padding-top: env(safe-area-inset-top, 0px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
      padding-left: env(safe-area-inset-left, 0px);
      padding-right: env(safe-area-inset-right, 0px);
    }
    .capacitor-native body { padding: 0; }
  }

  .screen {
    display: none;
    height: 100%;
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    flex-direction: column;
    opacity: 0;
    transition: opacity 0.3s ease;
    overflow: hidden;
  }
  .screen.active { display: flex; opacity: 1; }

  /* ===== SPLASH ===== */
  #splashScreen {
    background: radial-gradient(ellipse at center, #2c2c2c 0%, #1a1a1a 60%, #111 100%);
    justify-content: center;
    align-items: center;
    z-index: 100;
  }

  .splash-icon {
    font-size: 80px;
    animation: pulse-glow 1.5s ease-in-out infinite;
    margin-bottom: 20px;
    filter: drop-shadow(0 0 20px rgba(191,87,0,0.6));
  }

  @keyframes pulse-glow {
    0%, 100% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.15); opacity: 1; }
  }

  .splash-title {
    font-family: 'Oswald', sans-serif;
    font-size: 32px;
    font-weight: 700;
    color: var(--primary);
    text-transform: uppercase;
    letter-spacing: 4px;
    text-shadow: 0 2px 8px rgba(0,0,0,0.5);
  }

  .splash-subtitle {
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 4px;
    text-transform: uppercase;
    margin-top: 8px;
  }

  .splash-loader {
    margin-top: 30px;
    width: 120px;
    height: 3px;
    background: #333;
    border-radius: 2px;
    overflow: hidden;
  }

  .splash-loader-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--primary), var(--accent-gold));
    border-radius: 2px;
    animation: load-bar 1.8s ease-in-out forwards;
  }

  @keyframes load-bar {
    0% { width: 0%; }
    60% { width: 80%; }
    100% { width: 100%; }
  }

  /* ===== LOGIN ===== */
  #loginScreen {
    justify-content: center;
    align-items: center;
    padding: 40px 24px;
    background: radial-gradient(ellipse at 50% 30%, #2c2c2c 0%, #1a1a1a 60%, #111 100%);
    overflow-y: auto;
    touch-action: pan-y;
  }

  .login-logo { font-size: 64px; margin-bottom: 12px; filter: drop-shadow(0 0 16px rgba(191,87,0,0.5)); }

  .login-title {
    font-family: 'Oswald', sans-serif;
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
    text-transform: uppercase;
    letter-spacing: 3px;
    margin-bottom: 4px;
  }

  .login-tagline {
    font-size: 12px;
    color: var(--text-muted);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 32px;
  }

  .login-btn {
    width: 100%;
    max-width: 300px;
    padding: 14px;
    border-radius: 12px;
    border: 1px solid var(--medium-gray);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 15px;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    min-height: 48px;
  }
  .login-btn:hover { transform: translateY(-1px); }

  .login-btn-google { background: #fff; color: #1a1a1a; border-color: #666; }
  .login-btn-google:hover { background: #f5f5f5; }

  .login-btn-email { background: transparent; color: var(--accent-gold); border-color: var(--medium-gray); }
  .login-btn-email:hover { border-color: var(--primary); }

  .login-divider {
    display: flex; align-items: center; gap: 12px;
    margin: 16px 0; width: 100%; max-width: 300px;
    color: var(--medium-gray); font-size: 11px;
  }
  .login-divider::before, .login-divider::after {
    content: ''; flex: 1; height: 1px; background: var(--medium-gray);
  }

  .login-form { width: 100%; max-width: 300px; display: none; }
  .login-form.show { display: block; }

  .login-input {
    width: 100%; padding: 12px 14px; border-radius: 10px;
    border: 1px solid #333; background: rgba(0,0,0,0.4);
    color: var(--text); font-family: 'Source Sans 3', sans-serif;
    font-size: 14px; margin-bottom: 10px; outline: none;
    transition: border-color 0.2s;
  }
  .login-input:focus { border-color: var(--primary); }
  .login-input::placeholder { color: #666; }

  .login-submit {
    width: 100%; padding: 14px; border-radius: 12px; border: none;
    background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    color: #fff; font-family: 'Oswald', sans-serif; font-size: 16px;
    font-weight: 600; text-transform: uppercase; letter-spacing: 2px;
    cursor: pointer; margin-top: 4px; transition: all 0.2s; min-height: 48px;
  }
  .login-submit:hover { transform: translateY(-1px); filter: brightness(1.1); }

  .login-error {
    color: var(--danger); font-size: 13px; margin-top: 8px;
    text-align: center; min-height: 20px;
  }

  .login-toggle {
    color: var(--text-muted); font-size: 13px; margin-top: 12px;
    cursor: pointer; text-decoration: underline;
  }

  /* ===== GROUP SELECT ===== */
  #groupScreen {
    justify-content: center;
    align-items: center;
    padding: 40px 24px;
    background: linear-gradient(180deg, #1a1a1a, #2c2c2c);
  }

  .group-title {
    font-family: 'Oswald', sans-serif;
    font-size: 22px; font-weight: 600;
    color: var(--primary);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 24px;
  }

  .group-select {
    width: 100%; max-width: 300px; padding: 14px;
    border-radius: 12px; border: 1px solid var(--medium-gray);
    background: rgba(0,0,0,0.4); color: var(--text);
    font-family: 'Source Sans 3', sans-serif; font-size: 15px;
    margin-bottom: 16px; outline: none; cursor: pointer;
    -webkit-appearance: none; appearance: none;
  }

  /* (fuzzy dropdown styles below in .fuzzy-dropdown section) */

  .group-join-btn {
    width: 100%; max-width: 300px; padding: 14px;
    border-radius: 12px; border: none;
    background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    color: #fff; font-family: 'Oswald', sans-serif; font-size: 16px;
    font-weight: 600; text-transform: uppercase; letter-spacing: 2px;
    cursor: pointer; transition: all 0.2s;
  }
  .group-join-btn:hover { transform: translateY(-1px); filter: brightness(1.1); }

  /* ===== VOTING SCREEN ===== */
  #votingScreen {
    background: linear-gradient(180deg, #1a1a1a, #222);
  }

  .voting-header {
    text-align: center;
    padding: calc(12px + env(safe-area-inset-top, 0px)) 16px 10px;
    background: linear-gradient(180deg, rgba(44,44,44,0.95), rgba(26,26,26,0.9));
    border-bottom: 2px solid var(--primary);
    flex-shrink: 0;
    position: relative;
  }

  .voting-header-title {
    font-family: 'Oswald', sans-serif;
    font-size: 20px; font-weight: 700;
    color: var(--primary);
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .voting-header-date {
    font-size: 12px; color: var(--text-muted);
    letter-spacing: 1px; margin-top: 2px;
  }

  .voting-header-status {
    font-size: 11px; margin-top: 4px;
    letter-spacing: 1px; text-transform: uppercase;
  }
  .voting-header-status.open { color: var(--success); }
  .voting-header-status.closed { color: var(--danger); }

  .voting-logout {
    position: absolute; top: calc(12px + env(safe-area-inset-top, 0px)); right: 16px;
    background: none; border: none; color: var(--text-muted);
    font-size: 12px; cursor: pointer; padding: 4px 8px;
    font-family: 'Source Sans 3', sans-serif;
  }
  .voting-logout:hover { color: var(--text); }

  .voting-header-title-row {
    display: flex; align-items: center; justify-content: center;
    position: relative;
  }
  .voting-header-title { flex: 1; text-align: center; }
  .settings-btn {
    background: none; border: none; font-size: 20px; cursor: pointer;
    padding: 4px; opacity: 0.7; transition: opacity 0.2s;
    position: absolute; right: 0; top: 50%; transform: translateY(-50%);
  }
  .settings-btn:hover { opacity: 1; }

  .settings-overlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7); z-index: 100;
    justify-content: center; align-items: center;
  }
  .settings-overlay.show { display: flex; }
  .settings-modal {
    background: var(--dark-steel); border-radius: 16px; padding: 24px;
    width: 90%; max-width: 360px; color: var(--text);
  }
  .settings-title {
    font-family: 'Oswald', sans-serif; font-size: 20px; font-weight: 600;
    text-align: center; margin-bottom: 20px; color: var(--primary);
  }
  .settings-field {
    margin-bottom: 16px;
  }
  .settings-field label {
    display: block; font-size: 14px; color: var(--text-muted); margin-bottom: 6px;
  }
  .settings-input {
    width: 100%; padding: 10px 12px; border-radius: 8px;
    border: 1px solid var(--medium-gray); background: var(--near-black);
    color: var(--text); font-size: 16px;
  }
  .settings-stub { opacity: 0.5; }
  .settings-coming-soon {
    font-size: 12px; color: var(--text-muted); font-style: italic;
  }

  /* Notification toggle row */
  .notif-toggle-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .notif-toggle-row:last-child { border-bottom: none; }
  .notif-toggle-label {
    font-size: 14px; color: var(--text); line-height: 1.3;
  }
  .notif-toggle-sublabel {
    font-size: 11px; color: var(--text-muted); margin-top: 2px;
  }
  .toggle-switch {
    position: relative; width: 44px; height: 26px; flex-shrink: 0; margin-left: 12px;
  }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background: #444; border-radius: 26px; transition: background 0.2s;
  }
  .toggle-slider:before {
    position: absolute; content: '';
    height: 20px; width: 20px; left: 3px; bottom: 3px;
    background: #fff; border-radius: 50%; transition: transform 0.2s;
  }
  .toggle-switch input:checked + .toggle-slider { background: var(--primary); }
  .toggle-switch input:checked + .toggle-slider:before { transform: translateX(18px); }
  .notif-section-title {
    font-size: 12px; color: var(--text-muted); text-transform: uppercase;
    letter-spacing: 1px; margin: 12px 0 8px;
  }
  .notif-status-msg {
    font-size: 12px; color: var(--text-muted); margin-top: 6px;
    min-height: 16px; font-style: italic;
  }
  .settings-actions {
    display: flex; gap: 10px; margin-top: 20px;
  }
  .settings-save {
    flex: 1; padding: 10px; border: none; border-radius: 8px;
    background: var(--primary); color: white; font-weight: 600;
    font-size: 15px; cursor: pointer;
  }
  .settings-save:hover { background: var(--primary-dark); }
  .settings-cancel {
    flex: 1; padding: 10px; border: 1px solid var(--medium-gray); border-radius: 8px;
    background: transparent; color: var(--text-muted); font-size: 15px; cursor: pointer;
  }
  .settings-logout {
    width: 100%; padding: 12px; border: none; border-radius: 8px;
    background: var(--danger); color: #fff; font-family: 'Oswald', sans-serif;
    font-size: 15px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 1px; cursor: pointer; margin-top: 16px;
    transition: filter 0.2s;
  }
  .settings-logout:hover { filter: brightness(1.15); }
  .settings-section-label {
    font-family: 'Oswald', sans-serif; font-size: 13px; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; margin-top: 4px;
  }

  .voting-tabs {
    display: flex; flex-shrink: 0;
    border-bottom: 1px solid #333;
    background: rgba(0,0,0,0.3);
  }

  .voting-tab {
    flex: 1; padding: 10px; text-align: center;
    font-family: 'Oswald', sans-serif; font-size: 14px;
    text-transform: uppercase; letter-spacing: 1px;
    color: var(--text-muted); cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  .voting-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
  }

  .voting-content {
    flex: 1; overflow-y: auto; padding: 16px;
    -webkit-overflow-scrolling: touch;
    min-height: 0;
    scrollbar-width: none;
    touch-action: pan-y;
  }
  .voting-content::-webkit-scrollbar { display: none; }
  .voting-footer {
    flex-shrink: 0;
    padding: 12px 16px;
    border-top: 1px solid var(--medium-gray);
    overflow-y: auto;
    max-height: 40vh;
    scrollbar-width: none;
  }
  .voting-footer::-webkit-scrollbar { display: none; }
  .voting-footer:empty { display: none; }
  .voting-footer:not(:empty) { min-height: 160px; }

  /* Restaurant grid */
  .restaurant-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 16px;
  }

  .restaurant-btn {
    padding: 16px 10px;
    border-radius: 12px;
    border: 2px solid #333;
    background: rgba(255,255,255,0.03);
    color: var(--text);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    position: relative;
    min-height: 70px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }

  .restaurant-btn:hover { border-color: var(--primary); transform: translateY(-1px); }
  .restaurant-btn:active { transform: scale(0.97); }

  .restaurant-btn.voted {
    border-color: var(--primary);
    background: rgba(191,87,0,0.15);
    box-shadow: 0 0 12px rgba(191,87,0,0.2);
  }

  .restaurant-btn.dimmed {
    opacity: 0.5;
  }

  .restaurant-btn .vote-count {
    font-size: 20px; font-weight: 700;
    font-family: 'Oswald', sans-serif;
    color: var(--accent-gold);
  }

  .restaurant-btn .restaurant-name {
    font-size: 12px;
    line-height: 1.2;
    color: var(--text-muted);
  }

  .restaurant-btn.voted .restaurant-name { color: var(--text); }

  .add-restaurant-btn {
    grid-column: 1 / -1;
    padding: 12px;
    border-radius: 12px;
    border: 2px dashed #444;
    background: transparent;
    color: var(--text-muted);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .add-restaurant-btn:hover { border-color: var(--primary); color: var(--text); }

  .add-restaurant-form {
    display: none;
    grid-column: 1 / -1;
    gap: 8px;
  }
  .add-restaurant-form.show { display: flex; }

  .add-restaurant-form input {
    flex: 1; padding: 10px 12px; border-radius: 8px;
    border: 1px solid #444; background: rgba(0,0,0,0.3);
    color: var(--text); font-family: 'Source Sans 3', sans-serif;
    font-size: 14px; outline: none;
  }
  .add-restaurant-form input:focus { border-color: var(--primary); }

  .add-restaurant-form button {
    padding: 10px 16px; border-radius: 8px; border: none;
    background: var(--primary); color: #fff;
    font-family: 'Oswald', sans-serif; font-size: 14px;
    text-transform: uppercase; cursor: pointer;
  }

  /* Winner display */
  .winner-display {
    text-align: center;
    padding: 30px 20px;
    margin-bottom: 20px;
  }

  .winner-trophy { font-size: 64px; margin-bottom: 12px; }

  .winner-label {
    font-family: 'Oswald', sans-serif;
    font-size: 14px; color: var(--accent-gold);
    text-transform: uppercase; letter-spacing: 3px;
    margin-bottom: 4px;
  }

  .winner-name {
    font-family: 'Oswald', sans-serif;
    font-size: 28px; font-weight: 700;
    color: var(--primary);
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .winner-votes {
    font-size: 14px; color: var(--text-muted); margin-top: 4px;
  }

  /* Bar chart */
  .results-chart {
    margin-top: 16px;
  }

  .results-chart-title {
    font-family: 'Oswald', sans-serif;
    font-size: 14px; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 2px;
    margin-bottom: 12px;
    text-align: center;
  }

  .chart-bar-row {
    display: flex; align-items: center; margin-bottom: 8px; gap: 10px;
  }

  .chart-bar-label {
    width: 100px; font-size: 12px; color: var(--text-muted);
    text-align: right; flex-shrink: 0;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }

  .chart-bar-track {
    flex: 1; height: 24px; background: rgba(255,255,255,0.05);
    border-radius: 4px; overflow: hidden; position: relative;
  }

  .chart-bar-fill {
    height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent-gold));
    border-radius: 4px; transition: width 0.5s ease;
    min-width: 2px;
  }

  .chart-bar-count {
    width: 30px; font-size: 14px; font-weight: 700;
    font-family: 'Oswald', sans-serif; color: var(--text);
    flex-shrink: 0;
  }

  /* History */
  .history-list { list-style: none; }

  .history-item {
    padding: 12px 14px; margin-bottom: 8px;
    background: rgba(255,255,255,0.03);
    border-radius: 10px; border: 1px solid #333;
    display: flex; justify-content: space-between; align-items: center;
  }

  .history-date {
    font-size: 12px; color: var(--text-muted);
  }

  .history-winner {
    font-family: 'Oswald', sans-serif;
    font-size: 15px; color: var(--primary);
    font-weight: 600;
  }

  .no-votes-msg {
    text-align: center; color: var(--text-muted);
    padding: 40px 20px; font-size: 15px;
  }

  .pending-banner {
    background: rgba(196, 132, 29, 0.15);
    border: 1px solid var(--accent-gold);
    border-radius: 10px;
    padding: 12px 16px;
    margin: 8px 16px;
    flex-shrink: 0;
  }
  .pending-banner-title {
    font-family: 'Oswald', sans-serif;
    font-size: 13px; color: var(--accent-gold);
    text-transform: uppercase; letter-spacing: 1px;
    margin-bottom: 8px;
  }
  .pending-member-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 6px 0; font-size: 14px;
  }
  .pending-member-name { color: var(--text); }
  .pending-member-actions { display: flex; gap: 8px; }
  .pending-approve-btn, .pending-deny-btn {
    padding: 4px 12px; border-radius: 6px; border: none;
    font-size: 12px; font-weight: 600; cursor: pointer;
  }
  .pending-approve-btn { background: var(--success); color: #1a1a1a; }
  .pending-deny-btn { background: var(--danger); color: #fff; }

  /* Toast */
  .toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: rgba(44,44,44,0.95); color: var(--text);
    padding: 12px 24px; border-radius: 10px;
    font-size: 14px; z-index: 9999;
    opacity: 0; transition: opacity 0.3s;
    pointer-events: none; border: 1px solid #555;
    max-width: 90%;
  }
  .toast.show { opacity: 1; }

  /* Fuzzy search dropdown */
  .fuzzy-dropdown { position: relative; }
  .fuzzy-dropdown input {
    width: 100%; padding: 12px 14px; border-radius: 10px;
    border: 1px solid var(--medium-gray); background: var(--near-black);
    color: var(--text); font-family: 'Source Sans 3', sans-serif;
    font-size: 15px; outline: none; transition: border-color 0.2s;
  }
  .fuzzy-dropdown input:focus { border-color: var(--primary); }
  .fuzzy-dropdown input::placeholder { color: #666; }
  .fuzzy-dropdown-list {
    display: none; position: absolute; top: 100%; left: 0; right: 0;
    max-height: 200px; overflow-y: auto; z-index: 10;
    background: var(--dark-steel); border: 1px solid var(--medium-gray);
    border-radius: 0 0 10px 10px; margin-top: -1px;
    scrollbar-width: none;
  }
  .fuzzy-dropdown-list::-webkit-scrollbar { display: none; }
  .fuzzy-dropdown-list.open { display: block; }
  .fuzzy-dropdown-item {
    padding: 10px 14px; cursor: pointer; font-size: 14px;
    color: var(--text); transition: background 0.15s;
  }
  .fuzzy-dropdown-item:hover, .fuzzy-dropdown-item.active {
    background: rgba(191,87,0,0.2); color: var(--primary);
  }
  .fuzzy-dropdown-empty {
    padding: 10px 14px; font-size: 13px; color: var(--text-muted);
    font-style: italic;
  }

  /* Settings modal scrollable + logout */
  .settings-modal { max-height: 80vh; overflow-y: auto; scrollbar-width: none; }
  .settings-modal::-webkit-scrollbar { display: none; }
  .settings-logout-btn {
    width: 100%; margin-top: 16px; padding: 10px; border-radius: 8px;
    border: 1px solid var(--danger); background: transparent;
    color: var(--danger); font-size: 15px; cursor: pointer;
    font-family: 'Source Sans 3', sans-serif; transition: all 0.2s;
  }
  .settings-logout-btn:hover { background: rgba(231,76,60,0.15); }

  /* Restaurant management */
  .restaurant-mgmt-list { list-style: none; max-height: 200px; overflow-y: auto; scrollbar-width: none; }
  .restaurant-mgmt-list::-webkit-scrollbar { display: none; }
  .restaurant-mgmt-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .restaurant-mgmt-item:last-child { border-bottom: none; }
  .restaurant-mgmt-name {
    flex: 1; font-size: 14px; color: var(--text);
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .restaurant-mgmt-name input {
    width: 100%; padding: 4px 8px; border-radius: 6px;
    border: 1px solid var(--medium-gray); background: var(--near-black);
    color: var(--text); font-size: 14px; font-family: 'Source Sans 3', sans-serif;
  }
  .restaurant-mgmt-actions { display: flex; gap: 6px; margin-left: 8px; flex-shrink: 0; }
  .restaurant-mgmt-actions button {
    background: none; border: none; cursor: pointer; font-size: 16px;
    padding: 2px 4px; opacity: 0.7; transition: opacity 0.2s;
  }
  .restaurant-mgmt-actions button:hover { opacity: 1; }
  .restaurant-add-row {
    display: flex; gap: 8px; margin-top: 8px;
  }
  .restaurant-add-row input {
    flex: 1; padding: 8px 10px; border-radius: 8px;
    border: 1px solid var(--medium-gray); background: var(--near-black);
    color: var(--text); font-size: 14px; font-family: 'Source Sans 3', sans-serif;
  }
  .restaurant-add-row button {
    padding: 8px 14px; border-radius: 8px; border: none;
    background: var(--primary); color: #fff; font-size: 13px;
    font-weight: 600; cursor: pointer; white-space: nowrap;
  }

  /* Create Group */
  .fuzzy-dropdown-create {
    padding: 10px 14px; cursor: pointer; font-size: 14px;
    color: var(--primary); font-weight: 600;
    border-top: 1px solid rgba(255,255,255,0.08);
    transition: background 0.15s;
    display: flex; align-items: center; gap: 6px;
  }
  .fuzzy-dropdown-create:hover { background: rgba(191,87,0,0.15); }

  .create-group-overlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7); z-index: 200;
    justify-content: center; align-items: center;
  }
  .create-group-overlay.show { display: flex; }
  .create-group-modal {
    background: var(--dark-steel); border-radius: 16px; padding: 24px;
    width: 90%; max-width: 340px; color: var(--text);
  }
  .create-group-title {
    font-family: 'Oswald', sans-serif; font-size: 20px; font-weight: 600;
    text-align: center; margin-bottom: 4px; color: var(--primary);
  }
  .create-group-subtitle {
    text-align: center; font-size: 13px; color: var(--text-muted);
    margin-bottom: 20px;
  }
  .create-group-input {
    width: 100%; padding: 12px 14px; border-radius: 10px;
    border: 1px solid var(--medium-gray); background: var(--near-black);
    color: var(--text); font-family: 'Source Sans 3', sans-serif;
    font-size: 15px; outline: none; margin-bottom: 16px;
  }
  .create-group-input:focus { border-color: var(--primary); }
  .create-group-input::placeholder { color: #666; }
  .create-group-price {
    text-align: center; margin-bottom: 16px; padding: 12px;
    background: rgba(191,87,0,0.1); border-radius: 10px;
    border: 1px solid rgba(191,87,0,0.2);
  }
  .create-group-price-amount {
    font-family: 'Oswald', sans-serif; font-size: 28px;
    font-weight: 700; color: var(--primary);
  }
  .create-group-price-period {
    font-size: 13px; color: var(--text-muted);
  }
  .create-group-price-note {
    font-size: 11px; color: var(--text-muted); margin-top: 4px;
  }
  .create-group-btn {
    width: 100%; padding: 14px; border-radius: 12px; border: none;
    background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    color: #fff; font-family: 'Oswald', sans-serif; font-size: 16px;
    font-weight: 600; text-transform: uppercase; letter-spacing: 2px;
    cursor: pointer; transition: all 0.2s;
  }
  .create-group-btn:hover { transform: translateY(-1px); filter: brightness(1.1); }
  .create-group-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: none; }
  .create-group-cancel {
    width: 100%; padding: 10px; border: none; background: none;
    color: var(--text-muted); font-size: 14px; cursor: pointer;
    margin-top: 8px; font-family: 'Source Sans 3', sans-serif;
  }
  .create-group-error {
    color: var(--danger); font-size: 13px; text-align: center;
    margin-bottom: 12px; min-height: 18px;
  }
</style>
</head>
<body>
<div class="phone-frame">

  <!-- SPLASH -->
  <div id="splashScreen" class="screen active">
    <div class="splash-icon">üçî</div>
    <div class="splash-title">Lunch Bunch</div>
    <div class="splash-subtitle">Where are we eating?</div>
    <div class="splash-loader"><div class="splash-loader-fill"></div></div>
  </div>

  <!-- LOGIN -->
  <div id="loginScreen" class="screen">
    <div class="login-logo">üçî</div>
    <div class="login-title">Lunch Bunch</div>
    <div class="login-tagline">Vote ‚Ä¢ Eat ‚Ä¢ Repeat</div>

    <button class="login-btn login-btn-google" onclick="googleSignIn()">
      <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
      Sign in with Google
    </button>

    <div class="login-divider">or</div>

    <button class="login-btn login-btn-email" onclick="toggleEmailForm()">
      ‚úâÔ∏è Sign in with Email
    </button>

    <div id="emailForm" class="login-form">
      <input type="email" id="loginEmail" class="login-input" placeholder="Email address">
      <input type="password" id="loginPassword" class="login-input" placeholder="Password">
      <button class="login-submit" onclick="emailSignIn()">Sign In</button>
      <div id="loginError" class="login-error"></div>
    </div>
  </div>

  <!-- GROUP SELECT -->
  <div id="groupScreen" class="screen">
    <div class="group-title">Select Your Group</div>
    <div id="groupSelectDropdown" class="fuzzy-dropdown" style="width:100%;max-width:300px;margin-bottom:16px;"></div>
    <button class="group-join-btn" onclick="joinGroup()">Join Group</button>
  </div>

  <!-- VOTING -->
  <div id="votingScreen" class="screen">
    <div class="voting-header">
      <div class="voting-header-title-row">
        <div class="voting-header-title" id="groupNameDisplay">PGE Lunch Bunch</div>
        <button class="settings-btn" id="settingsBtn" onclick="openSettings()">‚öôÔ∏è</button>
      </div>
      <div class="voting-header-date" id="dateDisplay"></div>
      <div class="voting-header-status" id="statusDisplay"></div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-overlay" id="settingsOverlay" onclick="closeSettings()">
      <div class="settings-modal" onclick="event.stopPropagation()">
        <div class="settings-title">Settings</div>
        <div class="settings-field">
          <label>Switch Group</label>
          <div id="settingsGroupDropdown" class="fuzzy-dropdown"></div>
        </div>
        <div id="managerSettings" style="display:none;">
          <div class="settings-field">
            <label>Voting closes at:</label>
            <input type="time" id="settingsCloseTime" class="settings-input" onchange="autoSaveCloseTime()">
          </div>
          <div class="settings-field">
            <label>Restaurants</label>
            <ul class="restaurant-mgmt-list" id="restaurantMgmtList"></ul>
            <div class="restaurant-add-row">
              <input type="text" id="mgmtNewRestaurant" placeholder="Add restaurant...">
              <button onclick="mgmtAddRestaurant()">Add</button>
            </div>
          </div>
        </div>
        <!-- Push notification preferences (all users) -->
        <div class="settings-field" id="notifSettingsSection">
          <label>Push Notifications</label>
          <div class="notif-toggle-row">
            <div>
              <div class="notif-toggle-label">Voting reminder</div>
              <div class="notif-toggle-sublabel">1 hour before voting closes</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="notifReminderToggle" onchange="handleNotifToggle('reminder', this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="notif-toggle-row">
            <div>
              <div class="notif-toggle-label">Winner announcement</div>
              <div class="notif-toggle-sublabel">When voting closes each day</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="notifWinnerToggle" onchange="handleNotifToggle('winner', this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="notif-status-msg" id="notifStatusMsg"></div>
        </div>
        <div class="settings-actions">
          <button class="settings-cancel" onclick="closeSettings()">Close</button>
        </div>
        <button class="settings-logout" onclick="logout()">Logout</button>
      </div>
    </div>

    <div id="pendingBanner"></div>
    <div class="voting-tabs">
      <div class="voting-tab active" onclick="switchTab('vote')" id="tabVote">Vote</div>
      <div class="voting-tab" onclick="switchTab('history')" id="tabHistory">History</div>
    </div>

    <div class="voting-content" id="votingContent">
      <!-- Scrollable restaurant cards -->
    </div>
    <div class="voting-footer" id="votingFooter">
      <!-- Fixed bar chart at bottom -->
    </div>
  </div>

</div>

<div id="toast" class="toast"></div>

<!-- Create Group Modal -->
<div class="create-group-overlay" id="createGroupOverlay" onclick="closeCreateGroup()">
  <div class="create-group-modal" onclick="event.stopPropagation()">
    <div class="create-group-title">Create a Group</div>
    <div class="create-group-subtitle">Start your own Lunch Bunch</div>
    <input type="text" class="create-group-input" id="createGroupName" placeholder="Group name (e.g. Marketing Team Lunch)" maxlength="50">
    <div class="create-group-price">
      <div class="create-group-price-amount">$9.99<span style="font-size:16px;font-weight:400;color:var(--text-muted)">/year</span></div>
      <div class="create-group-price-period">Annual subscription ‚Ä¢ Cancel anytime</div>
      <div class="create-group-price-note">Free for all members ‚Äî only the manager pays</div>
    </div>
    <div class="create-group-error" id="createGroupError"></div>
    <button class="create-group-btn" id="createGroupBtn" onclick="handleCreateGroup()">Subscribe & Create</button>
    <button class="create-group-cancel" onclick="closeCreateGroup()">Cancel</button>
  </div>
</div>

<script>
// ===== FIREBASE INIT =====
firebase.initializeApp({
  apiKey: "AIzaSyASukqVBonypnEsr187Byd_DNdZdVuJRAA",
  authDomain: "lunch-bunch-jf.firebaseapp.com",
  projectId: "lunch-bunch-jf",
  storageBucket: "lunch-bunch-jf.firebasestorage.app",
  messagingSenderId: "434669680174",
  appId: "1:434669680174:web:731c4756e4226bf4b951bf"
});

const db = firebase.firestore();
const auth = firebase.auth();

// ===== STATE =====
let currentUser = null;
let currentGroup = null;
let restaurants = [];
let dailyExtras = [];
let extrasUnsubscribe = null;
let userVote = null;
let voteCounts = {};
let firstVoteTime = {}; // restaurant name -> earliest vote timestamp (ms)
let ballotUnsubscribe = null;
let groupManagers = [];
let groupSettings = { votingCloseTime: '11:50', timezone: 'America/Chicago' };
let currentTab = 'vote';
let winCounts = {}; // restaurant name -> number of historical wins

// ===== PUSH NOTIFICATION STATE =====
let fcmToken = null;
let notifPrefs = { reminder: false, winner: false };

// ===== PUSH NOTIFICATIONS =====

// Initialize push notifications (called after user logs in)
async function initPushNotifications() {
  if (!window.Capacitor || !window.Capacitor.isNativePlatform || !window.Capacitor.isNativePlatform()) return;
  const { FirebaseMessaging } = window.Capacitor.Plugins;
  if (!FirebaseMessaging) return;

  // Listen for FCM token (from AppDelegate bridge event or plugin)
  window.addEventListener('fcmTokenReceived', async (e) => {
    const token = e.detail && e.detail.token;
    if (token && currentUser) {
      fcmToken = token;
      await saveFcmToken(token);
    }
  });

  // Also try getting token directly via plugin
  try {
    const result = await FirebaseMessaging.getToken();
    if (result && result.token && currentUser) {
      fcmToken = result.token;
      await saveFcmToken(result.token);
    }
  } catch (e) {
    console.log('[Push] getToken failed (permission not yet granted):', e.message);
  }
}

// Save FCM token to Firestore user doc
async function saveFcmToken(token) {
  if (!currentUser || !token) return;
  try {
    await db.collection('users').doc(currentUser.uid).set({
      fcmToken: token,
      fcmTokenUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
    console.log('[Push] FCM token saved');
  } catch (e) {
    console.error('[Push] Failed to save FCM token:', e);
  }
}

// Load notification preferences from Firestore
async function loadNotifPrefs() {
  if (!currentUser) return;
  try {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const data = userDoc.data() || {};
    notifPrefs = { reminder: false, winner: false, ...(data.notificationPrefs || {}) };
  } catch (e) {
    console.error('[Push] Failed to load notif prefs:', e);
  }
}

// Save notification preferences to Firestore
async function saveNotifPrefs() {
  if (!currentUser) return;
  try {
    await db.collection('users').doc(currentUser.uid).set({
      notificationPrefs: notifPrefs,
      selectedGroup: currentGroup
    }, { merge: true });
  } catch (e) {
    console.error('[Push] Failed to save notif prefs:', e);
  }
}

// Handle toggle change in Settings modal
async function handleNotifToggle(type, enabled) {
  const isNative = window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform();
  if (!isNative) {
    setNotifStatusMsg('Push notifications only available in the iOS app.');
    // Revert toggle
    document.getElementById('notif' + (type === 'reminder' ? 'Reminder' : 'Winner') + 'Toggle').checked = false;
    return;
  }

  const { FirebaseMessaging } = window.Capacitor.Plugins;
  if (!FirebaseMessaging) {
    setNotifStatusMsg('Push plugin not available.');
    return;
  }

  if (enabled) {
    // Check/request permission
    const permResult = await FirebaseMessaging.checkPermissions();
    if (permResult.receive === 'denied') {
      setNotifStatusMsg('Notifications blocked. Enable in iOS Settings ‚Üí Notifications ‚Üí Lunch Bunch.');
      document.getElementById('notif' + (type === 'reminder' ? 'Reminder' : 'Winner') + 'Toggle').checked = false;
      return;
    }
    if (permResult.receive !== 'granted') {
      setNotifStatusMsg('Requesting permission‚Ä¶');
      const reqResult = await FirebaseMessaging.requestPermissions();
      if (reqResult.receive !== 'granted') {
        setNotifStatusMsg('Permission denied.');
        document.getElementById('notif' + (type === 'reminder' ? 'Reminder' : 'Winner') + 'Toggle').checked = false;
        return;
      }
    }

    // Get/refresh FCM token
    try {
      const result = await FirebaseMessaging.getToken();
      if (result && result.token) {
        fcmToken = result.token;
        await saveFcmToken(result.token);
      }
    } catch (e) {
      console.error('[Push] getToken error:', e);
    }

    setNotifStatusMsg('');
  }

  notifPrefs[type] = enabled;
  await saveNotifPrefs();
  setNotifStatusMsg(enabled ? 'Saved! ‚úì' : 'Disabled.');
  setTimeout(() => setNotifStatusMsg(''), 2000);
}

function setNotifStatusMsg(msg) {
  const el = document.getElementById('notifStatusMsg');
  if (el) el.textContent = msg;
}

// Update toggle UI state when settings opens
function updateNotifToggles() {
  const reminderEl = document.getElementById('notifReminderToggle');
  const winnerEl = document.getElementById('notifWinnerToggle');
  if (reminderEl) reminderEl.checked = notifPrefs.reminder || false;
  if (winnerEl) winnerEl.checked = notifPrefs.winner || false;

  // Dim notification section on non-native platforms (web browser)
  const section = document.getElementById('notifSettingsSection');
  if (section) {
    const isNative = window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform();
    section.style.opacity = isNative ? '1' : '0.5';
  }
}

// ===== HELPERS =====
function getCSTDate() {
  const now = new Date();
  const cst = new Date(now.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
  return cst;
}

function getCSTDateString() {
  const d = getCSTDate();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function isVotingOpen() {
  const now = getCSTDate();
  const [closeH, closeM] = groupSettings.votingCloseTime.split(':').map(Number);
  const nowMinutes = now.getHours() * 60 + now.getMinutes();
  const closeMinutes = closeH * 60 + closeM;
  return nowMinutes < closeMinutes;
}

function isManager() {
  return currentUser && groupManagers.includes(currentUser.email);
}

function formatCloseTime() {
  const [h, m] = groupSettings.votingCloseTime.split(':').map(Number);
  const period = h >= 12 ? 'PM' : 'AM';
  const displayH = h > 12 ? h - 12 : (h === 0 ? 12 : h);
  return `${displayH}:${m.toString().padStart(2, '0')} ${period}`;
}

function formatDate(dateStr) {
  const [y, m, d] = dateStr.split('-');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[parseInt(m)-1]} ${parseInt(d)}, ${y}`;
}

function showToast(msg, duration = 3000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// ===== SCREEN NAV =====
function navigateToScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
}

// ===== AUTH =====
async function googleSignIn() {
  // Native Capacitor: use native Google sign-in via @capacitor-firebase/authentication
  if (window.Capacitor && window.Capacitor.isNativePlatform()) {
    try {
      const result = await Capacitor.Plugins.FirebaseAuthentication.signInWithGoogle();
      const credential = firebase.auth.GoogleAuthProvider.credential(result.credential.idToken);
      await auth.signInWithCredential(credential);
    } catch (error) {
      console.error('Native Google sign-in error:', error);
      showToast('Google sign-in failed: ' + (error.message || 'Unknown error'));
    }
  } else {
    // Web: popup with redirect fallback
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => {
      if (err.code === 'auth/popup-blocked' || 
          err.code === 'auth/operation-not-supported-in-this-environment') {
        auth.signInWithRedirect(provider);
      } else {
        showToast('Google sign-in failed: ' + err.message);
      }
    });
  }
}

function toggleEmailForm() {
  document.getElementById('emailForm').classList.toggle('show');
}

function emailSignIn() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');
  errEl.textContent = '';

  if (!email || !password) { errEl.textContent = 'Please fill in all fields'; return; }

  auth.signInWithEmailAndPassword(email, password).catch(err => {
    if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
      auth.createUserWithEmailAndPassword(email, password).catch(e => {
        errEl.textContent = e.message;
      });
    } else {
      errEl.textContent = err.message;
    }
  });
}

function logout() {
  if (ballotUnsubscribe) { ballotUnsubscribe(); ballotUnsubscribe = null; }
  fcmToken = null;
  notifPrefs = { reminder: false, winner: false };
  auth.signOut();
}

// ===== HANDLE REDIRECT RESULT =====
auth.getRedirectResult().catch(err => {
  if (err.code !== 'auth/no-auth-event') {
    showToast('Google sign-in failed: ' + err.message);
  }
});

// ===== AUTH STATE =====
auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;

    // Save/update user doc
    const userRef = db.collection('users').doc(user.uid);
    await userRef.set({
      displayName: user.displayName || user.email,
      email: user.email,
      photoUrl: user.photoURL || '',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    // Initialize push notifications and load prefs
    await loadNotifPrefs();
    initPushNotifications(); // fire-and-forget (async token fetch)

    // Handle ?approve= and ?deny= query params
    const params = new URLSearchParams(window.location.search);
    const approveParam = params.get('approve');
    const denyParam = params.get('deny');
    if (approveParam) {
      try {
        await handleApproval(approveParam);
      } catch (e) {
        console.error('Approval error:', e);
        showToast('Approval error: ' + e.message, 5000);
      }
      window.history.replaceState({}, '', window.location.pathname);
    } else if (denyParam) {
      try {
        await handleDenial(denyParam);
      } catch (e) {
        console.error('Denial error:', e);
        showToast('Denial error: ' + e.message, 5000);
      }
      window.history.replaceState({}, '', window.location.pathname);
    }

    // Check for saved group
    const userDoc = await userRef.get();
    const savedGroup = userDoc.data()?.selectedGroup;

    if (savedGroup) {
      currentGroup = savedGroup;
      // Verify membership (manager or approved member)
      const groupDoc = await db.collection('groups').doc(savedGroup).get();
      const managers = groupDoc.exists ? (groupDoc.data().managers || []) : [];
      const memberDoc = await db.collection('groups').doc(savedGroup).collection('members').doc(user.uid).get();
      if (managers.includes(user.email) || memberDoc.exists) {
        loadVotingScreen();
      } else {
        // Check if pending
        const pendingDoc = await db.collection('groups').doc(savedGroup).collection('pendingMembers').doc(user.uid).get();
        if (pendingDoc.exists) {
          currentGroup = savedGroup;
          navigateToScreen('groupScreen');
          showPendingState();
        } else {
          navigateToScreen('groupScreen');
          initGroupSelectScreen();
        }
      }
    } else {
      navigateToScreen('groupScreen');
      initGroupSelectScreen();
    }
  } else {
    currentUser = null;
    currentGroup = null;
    navigateToScreen('loginScreen');
  }
});

async function handleApproval(approveParam) {
  // approveParam is "groupId/userId"
  const parts = approveParam.split('/');
  if (parts.length !== 2) { showToast('Invalid approval link'); return; }
  const [groupId, userId] = parts;

  // Verify current user is a manager
  const groupDoc = await db.collection('groups').doc(groupId).get();
  if (!groupDoc.exists) { showToast('Group not found'); return; }
  const managers = groupDoc.data().managers || [];
  if (!managers.includes(currentUser.email)) { showToast('Only managers can approve members'); return; }

  // Get pending member data
  const pendingRef = db.collection('groups').doc(groupId).collection('pendingMembers').doc(userId);
  const pendingDoc = await pendingRef.get();
  if (!pendingDoc.exists) { showToast('No pending request found (may already be approved)'); return; }

  // Move to members
  const data = pendingDoc.data();
  try {
    await db.collection('groups').doc(groupId).collection('members').doc(userId).set({
      email: data.email,
      displayName: data.displayName,
      joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    console.log('Added to members collection');
  } catch (e) {
    console.error('Failed to add to members:', e);
    showToast('Error adding member: ' + e.message);
    return;
  }

  try {
    await pendingRef.delete();
    console.log('Deleted pending request');
  } catch (e) {
    console.error('Failed to delete pending:', e);
  }

  // Set approved user's selectedGroup
  try {
    await db.collection('users').doc(userId).set({ selectedGroup: groupId }, { merge: true });
    console.log('Set selectedGroup for user', userId);
  } catch (e) {
    console.error('Failed to set selectedGroup:', e);
    // Non-critical ‚Äî user can still select group on next login
  }

  showToast(`Approved ${data.displayName || data.email}! ‚úÖ`, 5000);
}

async function handleDenial(denyParam) {
  const parts = denyParam.split('/');
  if (parts.length !== 2) { showToast('Invalid denial link'); return; }
  const [groupId, userId] = parts;

  const groupDoc = await db.collection('groups').doc(groupId).get();
  if (!groupDoc.exists) { showToast('Group not found'); return; }
  const managers = groupDoc.data().managers || [];
  if (!managers.includes(currentUser.email)) { showToast('Only managers can deny members'); return; }

  const pendingRef = db.collection('groups').doc(groupId).collection('pendingMembers').doc(userId);
  const pendingDoc = await pendingRef.get();
  if (!pendingDoc.exists) { showToast('No pending request found'); return; }

  const name = pendingDoc.data().displayName || pendingDoc.data().email;
  await pendingRef.delete();
  showToast(`Denied ${name} ‚ùå`);
}

// ===== GROUP =====
async function joinGroup() {
  const groupId = groupSelectInstance ? groupSelectInstance.getSelected() : null;
  if (!groupId) { showToast('Please select a group'); return; }
  currentGroup = groupId;

  // Load group to check if user is a manager
  const groupDoc = await db.collection('groups').doc(groupId).get();
  const managers = groupDoc.exists ? (groupDoc.data().managers || []) : [];

  if (managers.includes(currentUser.email)) {
    // Managers auto-approve: add to members and proceed
    await db.collection('groups').doc(groupId).collection('members').doc(currentUser.uid).set({
      email: currentUser.email,
      displayName: currentUser.displayName || currentUser.email,
      joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    await db.collection('users').doc(currentUser.uid).set({ selectedGroup: groupId }, { merge: true });
    loadVotingScreen();
  } else {
    // Check if already a member
    const memberDoc = await db.collection('groups').doc(groupId).collection('members').doc(currentUser.uid).get();
    if (memberDoc.exists) {
      await db.collection('users').doc(currentUser.uid).set({ selectedGroup: groupId }, { merge: true });
      loadVotingScreen();
      return;
    }
    // Check if already pending
    const pendingDoc = await db.collection('groups').doc(groupId).collection('pendingMembers').doc(currentUser.uid).get();
    if (pendingDoc.exists) {
      showPendingState();
      return;
    }
    // Create pending request
    await db.collection('groups').doc(groupId).collection('pendingMembers').doc(currentUser.uid).set({
      email: currentUser.email,
      displayName: currentUser.displayName || currentUser.email,
      requestedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    showPendingState();
  }
}

function showPendingState() {
  const groupScreen = document.getElementById('groupScreen');
  groupScreen.querySelector('.group-title').textContent = 'Awaiting Approval';
  const searchContainer = document.getElementById('groupSelectDropdown');
  if (searchContainer) searchContainer.style.display = 'none';
  groupScreen.querySelector('.group-join-btn').style.display = 'none';
  let pendingMsg = groupScreen.querySelector('.pending-msg');
  if (!pendingMsg) {
    pendingMsg = document.createElement('div');
    pendingMsg.className = 'pending-msg';
    pendingMsg.style.cssText = 'text-align:center;color:var(--text-muted);font-size:15px;margin-top:16px;max-width:300px;line-height:1.5;';
    groupScreen.appendChild(pendingMsg);
  }
  pendingMsg.textContent = 'Request sent! A group manager will approve your access. Check back soon.';

  // Add logout button
  let logoutBtn = groupScreen.querySelector('.pending-logout');
  if (!logoutBtn) {
    logoutBtn = document.createElement('button');
    logoutBtn.className = 'pending-logout';
    logoutBtn.textContent = 'Logout';
    logoutBtn.style.cssText = 'margin-top:20px;background:none;border:1px solid var(--medium-gray);color:var(--text-muted);padding:10px 24px;border-radius:8px;cursor:pointer;font-size:14px;';
    logoutBtn.onclick = logout;
    groupScreen.appendChild(logoutBtn);
  }
}

// ===== VOTING =====
async function loadVotingScreen() {
  navigateToScreen('votingScreen');

  const today = getCSTDateString();
  document.getElementById('dateDisplay').textContent = formatDate(today);

  // Load group data
  const groupDoc = await db.collection('groups').doc(currentGroup).get();
  if (groupDoc.exists) {
    const data = groupDoc.data();
    document.getElementById('groupNameDisplay').textContent = data.name || currentGroup;
    restaurants = data.restaurants || [];
    groupManagers = data.managers || [];
    if (data.settings) {
      groupSettings = { ...groupSettings, ...data.settings };
    }
    // One-time cleanup: remove Wingstop from permanent list (safe to remove after 2026-02-17)
    const _before = restaurants.length;
    restaurants = restaurants.filter(r => r.name !== 'Wingstop');
    if (restaurants.length < _before) {
      await db.collection('groups').doc(currentGroup).update({ restaurants });
    }
    // Seed managers if not set
    if (groupManagers.length === 0) {
      groupManagers = ['johntfosterjr@gmail.com'];
      await db.collection('groups').doc(currentGroup).update({ managers: groupManagers });
    }
    // Seed settings if not set
    if (!data.settings) {
      await db.collection('groups').doc(currentGroup).update({ settings: groupSettings });
    }
  } else {
    // Seed default restaurants if group doesn't exist yet
    restaurants = [
      {id: 'posse', name: 'Posse'},
      {id: 'crown-anchor', name: 'Crown & Anchor'},
      {id: 'taco-joint', name: 'Taco Joint'},
      {id: 'ullah-lake', name: 'Ullah-Lake'},
      {id: 'kinsolving', name: 'Kinsolving'},
      {id: 'torchys', name: "Torchy's Tacos"},
      {id: 'quality-seafood', name: 'Quality Seafood'},
      {id: 'kirby-lane', name: 'Kirby Lane'}
    ];
    await db.collection('groups').doc(currentGroup).set({
      name: 'PGE Lunch Bunch',
      restaurants: restaurants
    });
  }

  // Load historical win counts for sorting
  await loadWinCounts();

  // Auto-add manager as member if not already
  if (isManager()) {
    const memberDoc = await db.collection('groups').doc(currentGroup).collection('members').doc(currentUser.uid).get();
    if (!memberDoc.exists) {
      await db.collection('groups').doc(currentGroup).collection('members').doc(currentUser.uid).set({
        email: currentUser.email,
        displayName: currentUser.displayName || currentUser.email,
        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  }

  switchTab('vote');
  listenToBallots();
  updateVotingStatus();
  if (isManager()) loadPendingMembers();

  // Check status every minute
  setInterval(updateVotingStatus, 60000);
}

async function loadWinCounts() {
  winCounts = {};
  try {
    const snapshot = await db.collection('groups').doc(currentGroup)
      .collection('history').get();
    snapshot.forEach(doc => {
      const winner = doc.data().winner;
      if (winner) winCounts[winner] = (winCounts[winner] || 0) + 1;
    });
  } catch (e) {
    console.warn('Could not load win counts:', e);
  }
}

function sortRestaurants(list) {
  return list.slice().sort((a, b) => {
    const wA = winCounts[a.name] || 0;
    const wB = winCounts[b.name] || 0;
    if (wB !== wA) return wB - wA; // most wins first
    return a.name.localeCompare(b.name); // alphabetical tie-break
  });
}

function updateVotingStatus() {
  const statusEl = document.getElementById('statusDisplay');
  if (isVotingOpen()) {
    statusEl.textContent = `üü¢ Voting Open ‚Äî closes at ${formatCloseTime()}`;
    statusEl.className = 'voting-header-status open';
  } else {
    statusEl.textContent = 'üî¥ Voting Closed';
    statusEl.className = 'voting-header-status closed';
  }
  renderVoteTab();
}

function listenToBallots() {
  if (ballotUnsubscribe) ballotUnsubscribe();

  const today = getCSTDateString();
  const votesDocRef = db.collection('groups').doc(currentGroup)
    .collection('votes').doc(today);
  const ballotsRef = votesDocRef.collection('ballots');

  // Load daily extras from subcollection
  if (extrasUnsubscribe) extrasUnsubscribe();
  extrasUnsubscribe = votesDocRef.collection('extras').onSnapshot(snapshot => {
    dailyExtras = [];
    snapshot.forEach(doc => {
      dailyExtras.push({ id: doc.id, name: doc.data().name });
    });
    renderVoteTab();
  });

  ballotUnsubscribe = ballotsRef.onSnapshot(snapshot => {
    voteCounts = {};
    firstVoteTime = {};
    userVote = null;

    snapshot.forEach(doc => {
      const data = doc.data();
      const rName = data.restaurantName;
      voteCounts[rName] = (voteCounts[rName] || 0) + 1;

      // Track earliest vote per restaurant for tie-breaking
      const ts = data.timestamp ? data.timestamp.toMillis() : Infinity;
      if (!firstVoteTime[rName] || ts < firstVoteTime[rName]) {
        firstVoteTime[rName] = ts;
      }

      if (doc.id === currentUser.uid) {
        userVote = data;
      }
    });

    renderVoteTab();
  });
}

function switchTab(tab) {
  currentTab = tab;
  document.getElementById('tabVote').classList.toggle('active', tab === 'vote');
  document.getElementById('tabHistory').classList.toggle('active', tab === 'history');

  if (tab === 'vote') {
    renderVoteTab();
  } else {
    renderHistoryTab();
  }
}

function renderVoteTab() {
  if (currentTab !== 'vote') return;
  const content = document.getElementById('votingContent');
  const footer = document.getElementById('votingFooter');

  if (!isVotingOpen()) {
    footer.innerHTML = '';
    renderResults(content);
    return;
  }

  // Voting UI ‚Äî restaurant cards go in content (scrollable)
  let cardsHtml = '<div class="restaurant-grid">';

  const allRestaurants = sortRestaurants(restaurants.concat(dailyExtras.filter(e => !restaurants.find(r => r.id === e.id))));

  allRestaurants.forEach(r => {
    const count = voteCounts[r.name] || 0;
    const isVoted = userVote && userVote.restaurantId === r.id;
    const isDimmed = userVote && !isVoted;
    const classes = ['restaurant-btn'];
    if (isVoted) classes.push('voted');
    if (isDimmed) classes.push('dimmed');

    cardsHtml += `<button class="${classes.join(' ')}" onclick="castVote('${r.id}', '${r.name.replace(/'/g, "\\'")}')">
      <span class="vote-count">${count}</span>
      <span class="restaurant-name">${r.name}</span>
    </button>`;
  });

  // Check for votes on restaurants not in the group list or daily extras
  Object.keys(voteCounts).forEach(name => {
    if (!allRestaurants.find(r => r.name === name)) {
      const count = voteCounts[name] || 0;
      const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
      const isVoted = userVote && userVote.restaurantName === name;
      const isDimmed = userVote && !isVoted;
      const classes = ['restaurant-btn'];
      if (isVoted) classes.push('voted');
      if (isDimmed) classes.push('dimmed');
      cardsHtml += `<button class="${classes.join(' ')}" onclick="castVote('${id}', '${name.replace(/'/g, "\\'")}')">
        <span class="vote-count">${count}</span>
        <span class="restaurant-name">${name}</span>
      </button>`;
    }
  });

  if (!userVote) {
    cardsHtml += `<button class="add-restaurant-btn" onclick="showAddRestaurant()" id="addBtn">+ Add Restaurant</button>`;
    cardsHtml += `<div class="add-restaurant-form" id="addForm">
      <input type="text" id="newRestaurantName" placeholder="Restaurant name">
      <button onclick="addRestaurant()">Add</button>
    </div>`;
  }

  cardsHtml += '</div>';
  content.innerHTML = cardsHtml;

  // Live results bar chart ‚Äî goes in footer (fixed at bottom)
  let footerHtml = '';
  const sorted = Object.entries(voteCounts).sort((a, b) => b[1] - a[1] || (firstVoteTime[a[0]] || Infinity) - (firstVoteTime[b[0]] || Infinity));
  if (sorted.length > 0) {
    const maxVotes = sorted[0][1];
    footerHtml += '<div class="results-chart">';
    footerHtml += '<div class="results-chart-title">Live Results</div>';
    sorted.forEach(([name, count]) => {
      const pct = maxVotes > 0 ? (count / maxVotes * 100) : 0;
      footerHtml += `<div class="chart-bar-row">
        <div class="chart-bar-label">${name}</div>
        <div class="chart-bar-track"><div class="chart-bar-fill" style="width:${pct}%"></div></div>
        <div class="chart-bar-count">${count}</div>
      </div>`;
    });
    footerHtml += '</div>';
  }
  footer.innerHTML = footerHtml;
}

function renderResults(content) {
  // Determine winner
  const sorted = Object.entries(voteCounts).sort((a, b) => b[1] - a[1] || (firstVoteTime[a[0]] || Infinity) - (firstVoteTime[b[0]] || Infinity));

  if (sorted.length === 0) {
    content.innerHTML = '<div class="no-votes-msg">No votes were cast today</div>';
    return;
  }

  const maxVotes = sorted[0][1];
  const winner = sorted[0][0];

  let html = `<div class="winner-display">
    <div class="winner-trophy">üèÜ</div>
    <div class="winner-label">Today's Winner</div>
    <div class="winner-name">${winner}</div>
    <div class="winner-votes">${maxVotes} vote${maxVotes !== 1 ? 's' : ''}</div>
  </div>`;

  // Bar chart
  html += '<div class="results-chart">';
  html += '<div class="results-chart-title">Full Results</div>';

  sorted.forEach(([name, count]) => {
    const pct = maxVotes > 0 ? (count / maxVotes * 100) : 0;
    html += `<div class="chart-bar-row">
      <div class="chart-bar-label">${name}</div>
      <div class="chart-bar-track"><div class="chart-bar-fill" style="width:${pct}%"></div></div>
      <div class="chart-bar-count">${count}</div>
    </div>`;
  });

  html += '</div>';

  // Save winner to history
  saveHistory(winner, voteCounts);

  content.innerHTML = html;
}

async function saveHistory(winner, votes) {
  const today = getCSTDateString();
  const histRef = db.collection('groups').doc(currentGroup)
    .collection('history').doc(today);
  const doc = await histRef.get();
  if (!doc.exists) {
    try {
      await histRef.set({ winner, votes, savedAt: firebase.firestore.FieldValue.serverTimestamp() });
    } catch (e) {
      console.warn('Could not save history:', e);
    }
  }

  // Promote winner to permanent restaurant list if not already there
  const winnerId = winner.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  if (!restaurants.find(r => r.id === winnerId || r.name.toLowerCase() === winner.toLowerCase())) {
    restaurants.push({ id: winnerId, name: winner });
    try {
      await db.collection('groups').doc(currentGroup).update({ restaurants });
    } catch (e) {
      console.warn('Could not promote winner to permanent list:', e);
    }
  }
}

async function castVote(restaurantId, restaurantName) {
  if (!isVotingOpen()) {
    showToast('Voting is closed for today!');
    return;
  }

  if (userVote) {
    showToast('You already voted today!');
    return;
  }

  const today = getCSTDateString();
  try {
    await db.collection('groups').doc(currentGroup)
      .collection('votes').doc(today)
      .collection('ballots').doc(currentUser.uid)
      .set({
        restaurantId,
        restaurantName,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

    showToast('Vote cast! üó≥Ô∏è');
  } catch (e) {
    showToast('Error voting: ' + e.message);
  }
}

async function openSettings() {
  const mgr = isManager();
  document.getElementById('managerSettings').style.display = mgr ? 'block' : 'none';
  if (mgr) {
    document.getElementById('settingsCloseTime').value = groupSettings.votingCloseTime;
  }
  // Load group switcher
  const groups = await loadAllGroups();
  const container = document.getElementById('settingsGroupDropdown');
  settingsGroupInstance = createFuzzyDropdown(container, groups, async (groupId) => {
    if (groupId === currentGroup) { showToast('Already in this group'); return; }
    // Check membership
    const memberDoc = await db.collection('groups').doc(groupId).collection('members').doc(currentUser.uid).get();
    const groupDoc = await db.collection('groups').doc(groupId).get();
    const managers = groupDoc.exists ? (groupDoc.data().managers || []) : [];
    if (memberDoc.exists || managers.includes(currentUser.email)) {
      // Switch immediately
      if (managers.includes(currentUser.email) && !memberDoc.exists) {
        await db.collection('groups').doc(groupId).collection('members').doc(currentUser.uid).set({
          email: currentUser.email, displayName: currentUser.displayName || currentUser.email,
          joinedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      await db.collection('users').doc(currentUser.uid).set({ selectedGroup: groupId }, { merge: true });
      currentGroup = groupId;
      closeSettings();
      if (ballotUnsubscribe) { ballotUnsubscribe(); ballotUnsubscribe = null; }
      if (extrasUnsubscribe) { extrasUnsubscribe(); extrasUnsubscribe = null; }
      loadVotingScreen();
      showToast('Switched group!');
    } else {
      // Check if already pending
      const pendingDoc = await db.collection('groups').doc(groupId).collection('pendingMembers').doc(currentUser.uid).get();
      if (!pendingDoc.exists) {
        await db.collection('groups').doc(groupId).collection('pendingMembers').doc(currentUser.uid).set({
          email: currentUser.email, displayName: currentUser.displayName || currentUser.email,
          requestedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      await db.collection('users').doc(currentUser.uid).set({ selectedGroup: groupId }, { merge: true });
      closeSettings();
      currentGroup = groupId;
      navigateToScreen('groupScreen');
      showPendingState();
    }
  }, 'Search groups...', { showCreate: true });
  if (mgr) renderRestaurantMgmt();
  updateNotifToggles();
  setNotifStatusMsg('');
  document.getElementById('settingsOverlay').classList.add('show');
}

function closeSettings() {
  document.getElementById('settingsOverlay').classList.remove('show');
}

async function autoSaveCloseTime() {
  const closeTime = document.getElementById('settingsCloseTime').value;
  if (!closeTime) return;
  groupSettings.votingCloseTime = closeTime;
  try {
    await db.collection('groups').doc(currentGroup).update({ settings: groupSettings });
    showToast(`Voting closes at ${formatCloseTime()}`);
    updateVotingStatus();
  } catch (e) {
    showToast('Error saving: ' + e.message);
  }
}

function showAddRestaurant() {
  document.getElementById('addBtn').style.display = 'none';
  document.getElementById('addForm').classList.add('show');
  document.getElementById('newRestaurantName').focus();
}

async function addRestaurant() {
  const name = document.getElementById('newRestaurantName').value.trim();
  if (!name) return;

  const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-');

  // Check duplicate against permanent list + daily extras + votes
  if (restaurants.find(r => r.id === id || r.name.toLowerCase() === name.toLowerCase())) {
    showToast('Restaurant already exists!');
    return;
  }
  if (dailyExtras.find(r => r.id === id || r.name.toLowerCase() === name.toLowerCase())) {
    showToast('Restaurant already added today!');
    return;
  }

  // Add to today's daily extras subcollection (not permanent list)
  const today = getCSTDateString();
  await db.collection('groups').doc(currentGroup)
    .collection('votes').doc(today)
    .collection('extras').doc(id).set({ name });

  // Auto-vote for the restaurant you added
  await castVote(id, name);

  document.getElementById('newRestaurantName').value = '';
  showToast(`Added ${name}!`);
}

// ===== RESTAURANT MANAGEMENT =====
function renderRestaurantMgmt() {
  const list = document.getElementById('restaurantMgmtList');
  if (!list) return;
  const sorted = restaurants.slice().sort((a, b) => a.name.localeCompare(b.name));
  list.innerHTML = sorted.map(r => `
    <li class="restaurant-mgmt-item" data-id="${r.id}">
      <span class="restaurant-mgmt-name">${r.name}</span>
      <div class="restaurant-mgmt-actions">
        <button onclick="mgmtEditRestaurant('${r.id}')" title="Edit">‚úèÔ∏è</button>
        <button onclick="mgmtRemoveRestaurant('${r.id}')" title="Remove">üóëÔ∏è</button>
      </div>
    </li>
  `).join('');
}

function mgmtEditRestaurant(id) {
  const r = restaurants.find(x => x.id === id);
  if (!r) return;
  const item = document.querySelector(`.restaurant-mgmt-item[data-id="${id}"]`);
  const nameSpan = item.querySelector('.restaurant-mgmt-name');
  const oldName = r.name;
  nameSpan.innerHTML = `<input type="text" value="${oldName}" onkeydown="if(event.key==='Enter')mgmtSaveEdit('${id}',this)" onblur="mgmtSaveEdit('${id}',this)">`;
  nameSpan.querySelector('input').focus();
  nameSpan.querySelector('input').select();
}

async function mgmtSaveEdit(id, input) {
  const newName = input.value.trim();
  const r = restaurants.find(x => x.id === id);
  if (!r || !newName || newName === r.name) { renderRestaurantMgmt(); return; }
  r.name = newName;
  try {
    await db.collection('groups').doc(currentGroup).update({ restaurants });
    showToast(`Renamed to ${newName}`);
    renderRestaurantMgmt();
    renderVoteTab();
  } catch (e) {
    showToast('Error: ' + e.message);
  }
}

async function mgmtRemoveRestaurant(id) {
  const r = restaurants.find(x => x.id === id);
  if (!r) return;
  if (!confirm(`Remove "${r.name}" from voting cards? It will still appear in history.`)) return;
  restaurants = restaurants.filter(x => x.id !== id);
  try {
    await db.collection('groups').doc(currentGroup).update({ restaurants });
    showToast(`Removed ${r.name}`);
    renderRestaurantMgmt();
    renderVoteTab();
  } catch (e) {
    showToast('Error: ' + e.message);
  }
}

async function mgmtAddRestaurant() {
  const input = document.getElementById('mgmtNewRestaurant');
  const name = input.value.trim();
  if (!name) return;
  const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  if (restaurants.find(r => r.id === id || r.name.toLowerCase() === name.toLowerCase())) {
    showToast('Restaurant already exists!'); return;
  }
  restaurants.push({ id, name });
  try {
    await db.collection('groups').doc(currentGroup).update({ restaurants });
    input.value = '';
    showToast(`Added ${name}`);
    renderRestaurantMgmt();
    renderVoteTab();
  } catch (e) {
    showToast('Error: ' + e.message);
  }
}

// ===== HISTORY =====
async function renderHistoryTab() {
  const content = document.getElementById('votingContent');
  content.innerHTML = '<div class="no-votes-msg">Loading history...</div>';

  try {
    const snapshot = await db.collection('groups').doc(currentGroup)
      .collection('history')
      .orderBy('savedAt', 'desc')
      .limit(30)
      .get();

    if (snapshot.empty) {
      content.innerHTML = '<div class="no-votes-msg">No history yet</div>';
      return;
    }

    let html = '<ul class="history-list">';
    snapshot.forEach(doc => {
      const data = doc.data();
      html += `<li class="history-item">
        <span class="history-date">${formatDate(doc.id)}</span>
        <span class="history-winner">üèÜ ${data.winner}</span>
      </li>`;
    });
    html += '</ul>';
    content.innerHTML = html;
  } catch (e) {
    content.innerHTML = `<div class="no-votes-msg">Error loading history</div>`;
  }
}

// ===== PENDING MEMBERS =====
async function loadPendingMembers() {
  const bannerContainer = document.getElementById('pendingBanner');
  if (!bannerContainer) return;

  const snapshot = await db.collection('groups').doc(currentGroup).collection('pendingMembers').get();
  if (snapshot.empty) {
    bannerContainer.innerHTML = '';
    return;
  }

  let html = '<div class="pending-banner"><div class="pending-banner-title">‚è≥ ' + snapshot.size + ' Pending Member Request' + (snapshot.size !== 1 ? 's' : '') + '</div>';
  snapshot.forEach(doc => {
    const data = doc.data();
    html += `<div class="pending-member-row">
      <span class="pending-member-name">${data.displayName || data.email}</span>
      <div class="pending-member-actions">
        <button class="pending-approve-btn" onclick="approveMember('${doc.id}')">Approve</button>
        <button class="pending-deny-btn" onclick="denyMember('${doc.id}')">Deny</button>
      </div>
    </div>`;
  });
  html += '</div>';
  bannerContainer.innerHTML = html;
}

async function approveMember(userId) {
  const pendingRef = db.collection('groups').doc(currentGroup).collection('pendingMembers').doc(userId);
  const pendingDoc = await pendingRef.get();
  if (!pendingDoc.exists) { showToast('Request not found'); return; }

  const data = pendingDoc.data();
  await db.collection('groups').doc(currentGroup).collection('members').doc(userId).set({
    email: data.email,
    displayName: data.displayName,
    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  await pendingRef.delete();
  await db.collection('users').doc(userId).set({ selectedGroup: currentGroup }, { merge: true });

  showToast(`Approved ${data.displayName || data.email}! ‚úÖ`);
  loadPendingMembers();
}

async function denyMember(userId) {
  const pendingRef = db.collection('groups').doc(currentGroup).collection('pendingMembers').doc(userId);
  const pendingDoc = await pendingRef.get();
  if (!pendingDoc.exists) { showToast('Request not found'); return; }
  const name = pendingDoc.data().displayName || pendingDoc.data().email;
  await pendingRef.delete();
  showToast(`Denied ${name}`);
  loadPendingMembers();
}

// ===== FUZZY DROPDOWN =====
function createFuzzyDropdown(container, options, onSelect, placeholder, opts) {
  const { showCreate } = opts || {};
  container.innerHTML = '';
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = placeholder || 'Search...';
  const list = document.createElement('div');
  list.className = 'fuzzy-dropdown-list';
  container.appendChild(input);
  container.appendChild(list);

  let selectedValue = null;

  function render(filter) {
    const q = (filter || '').toLowerCase();
    const filtered = options.filter(o => o.label.toLowerCase().includes(q));
    if (filtered.length === 0) {
      list.innerHTML = '<div class="fuzzy-dropdown-empty">No matches</div>';
    } else {
      list.innerHTML = filtered.map(o =>
        `<div class="fuzzy-dropdown-item" data-value="${o.value}">${o.label}</div>`
      ).join('');
    }
    // Pinned "Create New Group" at bottom
    if (showCreate) {
      list.innerHTML += '<div class="fuzzy-dropdown-create" data-action="create">+ Create New Group</div>';
    }
    list.querySelectorAll('.fuzzy-dropdown-item').forEach(item => {
      item.addEventListener('click', () => {
        selectedValue = item.dataset.value;
        input.value = item.textContent;
        list.classList.remove('open');
        if (onSelect) onSelect(selectedValue);
      });
    });
    const createBtn = list.querySelector('.fuzzy-dropdown-create');
    if (createBtn) {
      createBtn.addEventListener('click', () => {
        list.classList.remove('open');
        openCreateGroup();
      });
    }
  }

  input.addEventListener('focus', () => { render(input.value); list.classList.add('open'); });
  input.addEventListener('input', () => { render(input.value); list.classList.add('open'); });
  document.addEventListener('click', (e) => {
    if (!container.contains(e.target)) list.classList.remove('open');
  });

  render('');
  return { getSelected: () => selectedValue, setOptions: (opts) => { options = opts; render(input.value); }, input };
}

let allGroupsCache = [];

async function loadAllGroups() {
  const snapshot = await db.collection('groups').get();
  allGroupsCache = [];
  snapshot.forEach(doc => {
    allGroupsCache.push({ value: doc.id, label: doc.data().name || doc.id });
  });
  return allGroupsCache;
}

let groupSelectInstance = null;
let settingsGroupInstance = null;

async function initGroupSelectScreen() {
  const groups = await loadAllGroups();
  const container = document.getElementById('groupSelectDropdown');
  groupSelectInstance = createFuzzyDropdown(container, groups, null, 'Search groups...', { showCreate: true });
}

// ===== CREATE GROUP =====
function openCreateGroup() {
  document.getElementById('createGroupName').value = '';
  document.getElementById('createGroupError').textContent = '';
  document.getElementById('createGroupBtn').disabled = false;
  document.getElementById('createGroupOverlay').classList.add('show');
  setTimeout(() => document.getElementById('createGroupName').focus(), 100);
}

function closeCreateGroup() {
  document.getElementById('createGroupOverlay').classList.remove('show');
}

async function handleCreateGroup() {
  const nameInput = document.getElementById('createGroupName');
  const errEl = document.getElementById('createGroupError');
  const btn = document.getElementById('createGroupBtn');
  const name = nameInput.value.trim();

  errEl.textContent = '';
  if (!name) { errEl.textContent = 'Please enter a group name'; return; }
  if (name.length < 3) { errEl.textContent = 'Name must be at least 3 characters'; return; }

  btn.disabled = true;
  btn.textContent = 'Creating...';

  try {
    // TODO: RevenueCat payment flow here
    // For now, stub: skip payment and create group directly
    // In production: verify subscription via RevenueCat before proceeding

    const groupId = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');

    // Check if group ID already exists
    const existing = await db.collection('groups').doc(groupId).get();
    if (existing.exists) {
      errEl.textContent = 'A group with that name already exists';
      btn.disabled = false;
      btn.textContent = 'Subscribe & Create';
      return;
    }

    // Check for duplicate name (case-insensitive) across all groups
    const allGroups = await db.collection('groups').get();
    const nameLower = name.toLowerCase();
    let duplicate = false;
    allGroups.forEach(doc => {
      if ((doc.data().name || '').toLowerCase() === nameLower) duplicate = true;
    });
    if (duplicate) {
      errEl.textContent = 'A group with that name already exists';
      btn.disabled = false;
      btn.textContent = 'Subscribe & Create';
      return;
    }

    // Create group doc
    await db.collection('groups').doc(groupId).set({
      name: name,
      managers: [currentUser.email],
      restaurants: [],
      settings: { votingCloseTime: '11:50', timezone: 'America/Chicago' },
      createdBy: currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      subscription: {
        status: 'trial', // TODO: 'active' after RevenueCat confirms payment
        platform: null,  // 'ios' | 'android' | 'web'
        productId: null,  // RevenueCat product ID
        expiresAt: null,  // Set by RevenueCat webhook
        customerId: null  // RevenueCat customer ID
      }
    });

    // Add creator as member
    await db.collection('groups').doc(groupId).collection('members').doc(currentUser.uid).set({
      email: currentUser.email,
      displayName: currentUser.displayName || currentUser.email,
      joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Set as selected group
    await db.collection('users').doc(currentUser.uid).set({ selectedGroup: groupId }, { merge: true });

    currentGroup = groupId;
    closeCreateGroup();
    closeSettings();

    // Reload into the new group
    if (ballotUnsubscribe) { ballotUnsubscribe(); ballotUnsubscribe = null; }
    if (extrasUnsubscribe) { extrasUnsubscribe(); extrasUnsubscribe = null; }
    loadVotingScreen();
    showToast(`"${name}" created! Add restaurants in Settings ‚öôÔ∏è`, 5000);

  } catch (e) {
    errEl.textContent = 'Error: ' + e.message;
  }

  btn.disabled = false;
  btn.textContent = 'Subscribe & Create';
}

// ===== INIT =====
setTimeout(() => {
  // Splash screen timeout ‚Äî auth listener will navigate
  if (document.getElementById('splashScreen').classList.contains('active') && !currentUser) {
    navigateToScreen('loginScreen');
  }
}, 2500);

// Prevent iOS rubber-band scrolling on non-scrollable areas
document.addEventListener('touchmove', function(e) {
  let target = e.target;
  while (target && target !== document.body) {
    const style = window.getComputedStyle(target);
    if (style.overflowY === 'auto' || style.overflowY === 'scroll') {
      if (target.scrollHeight > target.clientHeight) return; // allow scroll in scrollable areas
    }
    target = target.parentElement;
  }
  e.preventDefault();
}, { passive: false });
</script>
</body>
</html>
